(function(){var t,o,i=function(t,o){return function(){return t.apply(o,arguments)}},s=[].indexOf||function(t){for(var o=0,i=this.length;o<i;o++)if(o in this&&this[o]===t)return o;return-1};!function(t){return t.fn.rotationZoomer=function(t){return null==t&&(t={}),this.each(function(i,s){return new o(s,t)})}}($),o=function(){function o(t,o){this.zoom=i(this.zoom,this),this.handleClick=i(this.handleClick,this),this.$el=$(t),this.el=t,this.opts=o,this.parseOptions(),this.initialize()}return o.prototype.initialize=function(){return this.width=this.$el.width(),this.height=this.$el.height(),this.dimensions={vert:{w:this.width,h:this.height},hor:{w:this.height,h:this.width}},this.zoomer=null,this.wasCW=null,this.initializeCanvas()},o.prototype.initializeCanvas=function(){return this.$canvas=$("<canvas>"),this.$canvas.css({position:this.$el.css("position"),display:this.$el.css("display")}),this.$el.parents().first().append(this.$canvas),this.$el.css("display","none"),this.context=this.$canvas.get(0).getContext("2d"),this.bindControls(),this.transform()},o.prototype.parseOptions=function(){var t,o;return this.options={rotation:this.opts.rotation||0,rotateButton:this.opts.rotateButton,antiRotateButton:this.opts.antiRotateButton,zoomerEnabled:this.setDefault(this.opts.zoomerEnabled,!0),zoomerWidth:this.extractNums(this.opts.ZoomerWidth||150),zoomerHeight:this.extractNums(this.opts.ZoomerHeight||100),scale:this.opts.scale||2.5,zoomerBorderWidth:this.extractNums(this.opts.zoomerBorderWidth||1),zoomerBorderColor:this.opts.zoomerBorderColor||"black",zoomerBackgroundColor:this.opts.zoomerBackgroundColor||"white",closeOnClick:this.setDefault(this.opts.closeOnClick,!1),closeOnClickOutside:this.setDefault(this.opts.closeOnClickOutside,!0),showZoomerAfterRotation:this.setDefault(this.opts.showZoomerAfterRotation,!0)},this.opts.closeOnClick===!1&&this.opts.closeOnClickOutside===!1&&(this.options.closeOnClick=!0,this.options.closeOnClickOutside=!1,o="You passed invalid options:\n",o+="Options 'closeOnClick' and 'closeOnClickOutside' were both set to false. You cannot do this.\n",o+="Option 'closeOnClick' was set to true as a default.",console.warn(o)),0!==(t=this.options.rotation)&&90!==t&&180!==t&&270!==t&&(this.options.rotation=0,o="You passed invalid options:\n",o+="Options 'rotation' has invalid values, it must be in [0, 90, 180, 270].",o+="No other values allowed! Rotation set to 0.",console.warn(o)),console.log(this.options),this.deg=this.options.rotation,this.options},o.prototype.setDefault=function(t,o){return void 0===t||null===t?o:t},o.prototype.extractNums=function(t){return t=new String(t),parseInt(t.replace(/^\D+/g,""))},o.prototype.bindControls=function(){if(this.options.rotateButton&&(this.$rotateButton=$(this.options.rotateButton)),this.options.antiRotateButton&&(this.$antiRotateButton=$(this.options.antiRotateButton)),this.$rotateButton&&this.$rotateButton.on("click",function(t){return function(){return t.rotateCW()}}(this)),this.$antiRotateButton&&this.$antiRotateButton.on("click",function(t){return function(){return t.rotateACW()}}(this)),this.options.zoomerEnabled)return this.$canvas.on("click",this.handleClick)},o.prototype.setWidthAndHeight=function(){return this.hasHorizontalRotation()?(this.width=this.dimensions.hor.w,this.height=this.dimensions.hor.h):(this.width=this.dimensions.vert.w,this.height=this.dimensions.vert.h)},o.prototype.transform=function(){return this.setWidthAndHeight(),this.context.canvas.width=this.width,this.context.canvas.height=this.height,this.redraw()},o.prototype.rotate=function(){switch(this.context.save(),this.deg){case 90:this.context.translate(this.width,0);break;case 270:this.context.translate(0,this.height);break;case 180:this.context.translate(this.width,this.height);break;default:this.context.translate(0,0)}if(this.context.rotate(Math.PI/180*this.deg),!this.options.showZoomerAfterRotation)return this.closeZoomer},o.prototype.rotateCW=function(){return this.deg=this.deg+90>=360?0:this.deg+90,this.wasCW=!0,this.transform(),this.deg},o.prototype.rotateACW=function(){return this.deg=this.deg-90<0?270:this.deg-90,this.wasCW=!1,this.transform(),this.deg},o.prototype.hasHorizontalRotation=function(){return 90===this.deg||270===this.deg},o.prototype.clear=function(){return this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height)},o.prototype.redraw=function(){return this.clear(),this.rotate(),this.draw()},o.prototype.draw=function(){if(this.hasHorizontalRotation()?this.context.drawImage(this.el,0,0,this.height,this.width):this.context.drawImage(this.el,0,0,this.width,this.height),this.options.showZoomerAfterRotation&&null!==this.zoomer)return this.reopenZoomer()},o.prototype.handleClick=function(t){return this.coords={x:t.clientX-this.context.canvas.getBoundingClientRect().left,y:t.clientY-this.context.canvas.getBoundingClientRect().top},this.checkClickedArea()?(this.closeZoomer(),this.redraw()):null===this.zoomer?this.zoom(t):void 0},o.prototype.didClickOnZoomer=function(){return this.zoomer.inBounds(this.coords)},o.prototype.checkClickedArea=function(){var t;return!!this.zoomer&&(t=this.didClickOnZoomer(),!(!this.options.closeOnClick||!this.options.closeOnClickOutside)||(this.options.closeOnClick?t:!t))},o.prototype.inBounds=function(){return this.zoomer.originX()+this.zoomerWidth()>=this.width?this.zoomer.x=this.width-this.zoomerWidth()/2:this.zoomer.originX()<=0&&(this.zoomer.x=this.zoomerWidth()/2),this.zoomer.originY()+this.zoomerHeight()>=this.height?this.zoomer.y=this.height-this.zoomerHeight()/2:this.zoomer.originY()<=0?this.zoomer.y=this.zoomerHeight()/2:void 0},o.prototype.zoomerWidth=function(){return this.options.zoomerWidth+2*this.options.zoomerBorderWidth},o.prototype.zoomerHeight=function(){return this.options.zoomerHeight+2*this.options.zoomerBorderWidth},o.prototype.zoom=function(t){return this.openZoomer()},o.prototype.closeZoomer=function(){return this.zoomer=null},o.prototype.reopenZoomer=function(){var t,o;return t=this.zoomer.x,o=this.zoomer.y,this.wasCW?(this.coords.x=this.width-o,this.coords.y=t):(this.coords.x=o,this.coords.y=this.height-t),this.openZoomer()},o.prototype.openZoomer=function(){var o;return this.sourceCoords={x:-this.coords.x+this.options.zoomerWidth/2/this.options.scale,y:-this.coords.y+this.options.zoomerHeight/2/this.options.scale},o=$("<canvas>").get(0).getContext("2d"),o.canvas.width=this.options.zoomerWidth,o.canvas.height=this.options.zoomerHeight,o.fillStyle=this.options.zoomerBackgroundColor,o.fillRect(0,0,o.canvas.width,o.canvas.height),o.scale(this.options.scale,this.options.scale),o.translate(this.sourceCoords.x,this.sourceCoords.y),o.drawImage(this.context.canvas,0,0),this.zoomer=new t(o,this),this.initializeZoomer()},o.prototype.initializeZoomer=function(){return this.context.restore(),this.inBounds(),this.context.drawImage(this.zoomer.context.canvas,this.zoomer.originX(),this.zoomer.originY(),this.zoomer.context.canvas.width,this.zoomer.context.canvas.height),this.context.strokeStyle=this.options.zoomerBorderColor,this.context.lineWidth=this.options.zoomerBorderWidth,this.context.strokeRect(this.zoomer.originX(),this.zoomer.originY(),this.zoomer.context.canvas.width,this.zoomer.context.canvas.height)},o}(),t=function(){function t(t,o){this.context=$.extend(!0,{},t),this.instance=o,this.instanceOptions=o.options,this.x=o.coords.x,this.y=o.coords.y,this.bounds={top:this.originY(),left:this.originX(),width:this.instance.zoomerWidth(),height:this.instance.zoomerHeight()}}return t.prototype.originX=function(){return this.x-this.instanceOptions.zoomerWidth/2},t.prototype.originY=function(){return this.y-this.instanceOptions.zoomerHeight/2},t.prototype.inBounds=function(t){var o,i;return o=t.x,s.call(this.axisX(),o)>=0&&(i=t.y,s.call(this.axisY(),i)>=0)},t.prototype.axisY=function(){var t,o;return function(){o=[];for(var i=t=this.bounds.top,s=this.bounds.top+this.bounds.height;t<=s?i<=s:i>=s;t<=s?i++:i--)o.push(i);return o}.apply(this)},t.prototype.axisX=function(){var t,o;return function(){o=[];for(var i=t=this.bounds.left,s=this.bounds.left+this.bounds.width;t<=s?i<=s:i>=s;t<=s?i++:i--)o.push(i);return o}.apply(this)},t}()}).call(this);